name: YouTube Shorts Uploader

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      video_path:
        description: 'Path to video file'
        required: true
        default: 'D:/MW_TVS/Snatch (2000) [BluRay] [1080p] [YTS.AM]/Snatch.2000.1080p.BluRay.x264-[YTS.AM].mp4'
      clip_duration:
        description: 'Duration of each clip in seconds'
        required: true
        default: '50'

env:
  PYTHON_VERSION: '3.8'
  VENV_PATH: venv

jobs:
  process-and-upload:
    name: Process Video and Upload Shorts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    timeout-minutes: 60

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ”§ Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m venv ${{ env.VENV_PATH }}
        source ${{ env.VENV_PATH }}/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8

    - name: ğŸ” Lint Code
      run: |
        source ${{ env.VENV_PATH }}/bin/activate
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: ğŸ§ª Run Tests
      run: |
        source ${{ env.VENV_PATH }}/bin/activate
        pytest -v

    - name: ğŸ¬ Process Video
      id: process-video
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      run: |
        source ${{ env.VENV_PATH }}/bin/activate
        echo "Starting video processing..."
        python video_processing.py \
          --video_path "${{ github.event.inputs.video_path }}" \
          --clip_duration ${{ github.event.inputs.clip_duration }} \
          --api_key "${{ secrets.YOUTUBE_API_KEY }}"
        echo "::set-output name=duration::$(date +%s)"

    - name: ğŸ“¤ Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: process-artifacts
        path: |
          video_processing.log
          clip_*.mp4
        retention-days: 1

    - name: ğŸ“± Send Notification
      if: always()
      uses: appleboy/telegram-action@v1.6.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          *ğŸ¬ YouTube Shorts Upload Status*
          Repository: `${{ github.repository }}`
          Branch: `${{ github.ref_name }}`
          Status: `${{ job.status }}`
          
          ${{ job.status == 'success' && 'âœ… All clips processed and uploaded successfully!' || 'âŒ Process failed. Check logs for details.' }}
